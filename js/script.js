var server,peers;function arrayBufferToString(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function stringToArrayBuffer(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),a=0,o=e.length;a<o;a++)n[a]=e.charCodeAt(a);return t}function signin(){document.getElementById("main").style.display="none",document.getElementById("signin-area").style.display="inline",document.getElementById("signup-area").style.display="none",document.getElementById("error").style.display="inline",document.getElementById("name").value="",document.getElementById("error").innerHTML=""}function signup(){document.getElementById("main").style.display="none",document.getElementById("signin-area").style.display="none",document.getElementById("signup-area").style.display="inline",document.getElementById("error").style.display="inline",document.getElementById("key").value="",document.getElementById("error").innerHTML=""}async function login(e){try{window.privateKey=await crypto.subtle.importKey("jwk",JSON.parse(e),{name:"ECDSA",namedCurve:"P-384"},!0,["sign"])}catch(e){return void console.log(e)}window.localStorage.setItem("key",e);let t=Object.assign({},window.privateKey);delete t.d,delete t.dp,delete t.dq,delete t.q,delete t.qi,t.key_ops=["verify"],t.kty="EC",t.crv="P-384",t.x=JSON.parse(localStorage.getItem("key")).x,t.y=JSON.parse(localStorage.getItem("key")).y,window.publicKeyRaw=JSON.stringify(t),window.publicKey=await crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-384"},!0,["verify"]),initClient()}async function createAccount(e){window.localStorage.setItem("name",e),document.getElementById("change-display-name").value=e;const t=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-384"},!0,["sign","verify"]);window.publicKey=t.publicKey,window.privateKey=t.privateKey;let n=await exportCryptoKey(t.privateKey);window.publicKeyRaw=JSON.stringify(await exportCryptoKey(t.publicKey)),window.localStorage.setItem("key",JSON.stringify(n)),initClient()}function initClient(){server=new ServerConnection,peers=new PeersManager(server),Events.on("text-received",e=>{displayMessage(JSON.parse(e.detail.text),!0)})}async function exportCryptoKey(e){return await window.crypto.subtle.exportKey("jwk",e)}function switchTheme(){"0"===localStorage.getItem("preference")?(document.body.classList.add("dark-mode"),localStorage.setItem("preference","1")):(document.body.classList.remove("dark-mode"),localStorage.setItem("preference","0"))}async function signout(){document.getElementById("chat").style.display="none",document.getElementById("sign-out-button").style.display="none",document.getElementById("main").style.display="inline",document.getElementById("change-name").style.display="none",document.getElementById("change-name-button").style.display="none",localStorage.clear(),server.send({type:"disconnect"}),server._socket.onclose=null,await server._socket.close(),document.removeEventListener("visibilitychange",server.onVisibilityChange)}async function sendMessage(){if(""===document.getElementById("chat-message-input").value)return;let e=arrayBufferToString(await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-384"}},window.privateKey,(new TextEncoder).encode(document.getElementById("chat-message-input").value))),t={name:localStorage.getItem("name"),publicKey:window.publicKeyRaw,content:document.getElementById("chat-message-input").value,signature:e};for(const e in peers.peers)Events.fire("send-text",{to:e,text:JSON.stringify(t)});displayMessage(t),document.getElementById("chat-message-input").value=""}async function displayMessage(e,t=!1){if(t){const t=await crypto.subtle.importKey("jwk",JSON.parse(e.publicKey),{name:"ECDSA",namedCurve:"P-384"},!0,["verify"]),n=stringToArrayBuffer(e.signature);if(!await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-384"}},t,n,(new TextEncoder).encode(e.content)))return void console.log("Error: signature does not match")}let n=document.createElement("p");n.innerHTML=e.content,document.getElementById("chat-container").appendChild(n)}function showChatPage(){document.getElementById("main").style.display="none",document.getElementById("signin-area").style.display="none",document.getElementById("signup-area").style.display="none",document.getElementById("chat").style.display="inline",document.getElementById("sign-out-button").style.display="inline",document.getElementById("error").style.display="none",document.getElementById("change-name-button").style.display="inline"}function showNamePage(){document.getElementById("chat").style.display="none",document.getElementById("change-name").style.display="inline",document.getElementById("change-name-button").style.display="none"}function finishNameChange(){document.getElementById("chat").style.display="inline",document.getElementById("change-name").style.display="none",document.getElementById("change-name-button").style.display="inline"}document.getElementById("sign-up").onsubmit=function(e){e.preventDefault(),""!==document.getElementById("name").value?(createAccount(document.getElementById("name").value),showChatPage()):document.getElementById("error").innerHTML='<p style="color:red;text-align:center">Display name cannot be empty</p>'},document.getElementById("sign-in").onsubmit=function(e){e.preventDefault(),""!==document.getElementById("key").value?(login(document.getElementById("key").value),localStorage.setItem("name",document.getElementById("display-name").value),document.getElementById("change-display-name").value=document.getElementById("display-name").value,showChatPage()):document.getElementById("error").innerHTML='<p style="color:red;text-align:center">Private key cannot be emtpy</p>'},document.getElementById("chat-message-input").addEventListener("onkeydown",function(e){13===e.keyCode&&(e.preventDefault(),document.getElementById("send-message-button").click())}),document.getElementById("chat-input").onsubmit=function(e){e.preventDefault(),""!==document.getElementById("chat-message-input").value&&sendMessage()},document.getElementById("change-name-form").onsubmit=function(e){e.preventDefault(),""!==document.getElementById("change-display-name").value||null!==localStorage.getItem("name")?(""!==document.getElementById("change-display-name").value&&localStorage.setItem("name",document.getElementById("change-display-name").value),finishNameChange()):document.getElementById("error").innerHTML='<p style="color:red;text-align:center">Display name cannot be empty</p>'},window.onload=async function(){if(null===localStorage.getItem("preference")&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?localStorage.setItem("preference","1"):localStorage.setItem("preference","0")),"1"===localStorage.getItem("preference")&&document.body.classList.add("dark-mode"),null!==localStorage.getItem("key")){window.privateKey=await crypto.subtle.importKey("jwk",JSON.parse(localStorage.getItem("key")),{name:"ECDSA",namedCurve:"P-384"},!0,["sign"]);let e=Object.assign({},window.privateKey);delete e.d,delete e.dp,delete e.dq,delete e.q,delete e.qi,e.key_ops=["verify"],e.kty="EC",e.crv="P-384",e.x=JSON.parse(localStorage.getItem("key")).x,e.y=JSON.parse(localStorage.getItem("key")).y,window.publicKeyRaw=JSON.stringify(e),window.publicKey=await crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-384"},!0,["verify"]),showChatPage(),null!==localStorage.getItem("name")&&""!==localStorage.getItem("name")?document.getElementById("change-display-name").value=localStorage.getItem("name"):showNamePage(),initClient()}};
